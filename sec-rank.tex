\vspace{2ex}
%%%%%%%% Section 3 %%%%%%%%
\section{Ranking Cache Schemas}
\label{sec-rank}


We next develop criteria for ranking \bdss. We then
formulate the \bds selection problem  and
prove its intractability.


\warn{\stitle{Scan-free evaluability}.
One naturally wants to find \bdss that can make as many queries
scan-free as possible to benefit from scan-free evaluation of
\baav databases.  However, this alone does not make good \bdss.
For instance, recall query $Q_{1}$ and \bss $\kb{\at{T}}_{1}$
and $\kb{\at{T}}_{1}'$ from Example~\ref{exa-baav}; $Q_{1}$ is
scan-free over both $\kb{\at{T}}_{1}$ and $\kb{\at{T}}_{1}'$
while its scan-free plan over $\kb{\at{T}}_{1}$ is superior than
that over $\kb{\at{T}}_{2}$ since it fetches fewer attributes
and hence access fewer values. Moreover, making all queries
scan-free evaluable may not always be possible unless we use
\bss with small or even empty key attribute sets and large value
attribute sets, which basically fall back to table scans as the
conventional tuple-as-a-value model does.}


\vspace{0.6ex}
\warn{This motivates us to consider the {\em degrees} of \bss
below to further measure the quality of \bdss,
 % in addition to scan-free evaluability,
to distinguish good \bdss from bad ones although over both
queries can be scan-free.}

\warn{\stitle{Degree}.
The degree of a \bs $\kb{R}\bschema{X}{Y}$, denoted by
$\deg(\kb{R})$, is the size $|Y|$ of $Y$, \ie the number of
attributes in $Y$. Intuitively, we favor \bss with smaller
degrees since \get operations over them tend to fetch smaller
blocks of values. For example, the scan-free evaluation of
$Q_{1}$ over $\kb{\at{T}}_{1}$ fetches fewer \at{transaction}
values than over $\kb{\at{T}}'_{1}$.}

\warn{The degree of a \bds $\kb{\R}$, denoted by $\deg(\kb{\R})$, is
then defined as the sum of the degrees of \bss in $\kb{\R}$.}



\warn{\stitle{Ranking \bds}. We are now ready to give the ranking
function we will use for \baav schema design.  Given database
schema $\R$ and a set $\Q$ of parametric queries over $\R$, we
rank \bds $\kb{\R}$ that are in normal form for $\Q$ via an
aggregated ranking function: %$f(\Q, \kb{\R})$:
\[f(\Q, \kb{\R}) = c_{1}*\usf(\Q, \ak \kb{\R}) + c_{2}*\deg(\kb{\R}) + \ak c_{3}*\size(\kb{\R}),\]
where $c_{1}$, $c_{2}$ and $c_{3}$ are importance coefficients
of the criteria given by the users and are normalized, \ie
$\sum_{i=1}^{3}c_{i} = 1$; and
\bi
  \item $\usf(\Q, \kb{\R})$ measures the number of parametric
queries in $\Q$ that are {\em not} scan-free evaluable over $\kb{\R}$;
  \item $\deg(\Q, \kb{\R})$ is the total degree of $\kb{\R}$;
    and
  \item  $\size(\kb{\R})$ measures the total size of \bss in $\kb{\R}$.
\ei
In particular, $\size(\kb{\R})$ is defined as the total number
of attributes in \bss of $\kb{\R}$, \ie
$\size(\kb{\R}) = \sum_{\bschema{X}{Y}\in \kb{R}}|XY|$.
Intuitively, it is a schema level estimation of the size of \baav databases
of $\kb{\R}$ at the schema level; the smaller $\size(\kb{\R})$
is, the smaller the \baav databases of $\kb{\R}$.}


\warn{\stitle{Remark}.
(1) Scan-free evaluability and degrees are measures unique to
\bds and hence the \baav model, and have not been used in the
conventional database design or index and view selection
problems. They have to work together in order to measure the
performance of scan-free evaluation (and general query
evaluation as well) over \bdss.  As will be shown shortly, they
make \baav schema design more intriguing than their conventional
counterparts.

\sstab (2) We acknowledge that there are many other conventional
criteria for ranking indices and views can also be applied to
measure \bdss, such as the database size and incremental
maintenance cost. However, to focus more on the new challenges
incited by the \baav model (\ie scan-free evaluability and
degrees), we only adopted the size of \baav databases in
$f(\Q, \kb{\R})$, measured by $\size(\kb{\R})$ at the schema
level. In doing so, we also align with the main targeted
application scenarios of \baav databases, \ie analytical \SQL
queries for SQL-over-NoSQL (key-value) systems.
This said, in practice one can include more coarse-grained
criteria in $f(\Q, \kb{\R})$ based on the targeted applications.
Our algorithms to be presented shortly are generic and robust to
such extensions.


\sstab (3) One can also attach an importance weight $w_{Q}$ to
each parametric query $Q$ in $\Q$, representing \eg its
frequency of being instantiated in the workload. We remark that
all the results in the sequel remain unchanged for such weighted
version.}





\begin{example}\label{exa-measures}
Recall $\kb{\R}_{1}$ and $\kb{\R}_{2}$ from Example~\ref{exa-mapping}.
Let $\Q$ consist of only $Q_{1}$ from Example~\ref{exa-baav}.
Consider rank function $f_{0}(\Q, \kb{\R})$ with $c_{1} = 0.98$
and  $c_{2} = c_{3} = 0.01$.
%
Then $\usf(\Q, \ak \kb{\R}_{1}) \ak = \ak 0$ since $Q_{1}$ is
scan-free over $\kb{\R}_{1}$.
One can further verify that
$\daccess(\Q, \ak \kb{\R}_{1}) \ak = \ak 3$ and
$\size(\Q, \ak \kb{\R}_{1}) \ak = \ak 7$.
Hence $f_{0}(\Q, \kb{\R}_{1}) = 0.1$.

\vspace{0.6ex}
Similarly, for $\kb{\R}_{2}$ we have that
$\usf(\Q, \ak \kb{\R}_{2})\ak =\ak 0$,
$\daccess(\Q, \ak \kb{\R}_{2}) \ak = \ak 5$ and
$\size(\Q, \ak \kb{\R}_{2}) \ak = \ak 13$.  Hence,
$f_{0}(\Q, \kb{\R}_{2}) = 0.18$, \ie $\kb{\R}_{2}$ is worse than
$\kb{\R}_{1}$ under $f_{0}$. Indeed, one can readily verify that
$\kb{\R}_{1}$ is superior under $f(\Q, \kb{\R})$ with all
possible coefficients $c_{1}$, $c_{2}$ and $c_{3}$.

\vspace{0.6ex}
Now consider a revision $\kb{\R}_{3}$ of $\kb{\R}_{2}$ without
$\kb{\at{T}}_{1}$. Then
$Q_{1}$ is not scan-free over $\kb{\R}_{3}$ and hence
$\usf(\Q,\ak \kb{\R}_{3}) = 1$. Further, observe that
$\daccess(\Q, \ak \kb{\R}_{3}) = 4$ and
$\size(\Q, \ak \kb{\R}_{3}) \ak = \ak 10$.
Hence $f_{0}(\Q,\ak \kb{\R}_{3})\ak =\ak 1.12$,
\ie $\kb{\R}_{3}$ is ranked lower than $\kb{\R}_{2}$ by $f_{0}$.
\end{example}

\vspace{-0.4ex}




\stitle{The problem of \bds selection}.
The {\em \baav schema selection problem} is to compute,
given a workload $\Q$ over $\R$ and an aggregate rank function
$f$ (\ie $c_{1}$, \ldots, $c_{4}$),
the optimal \bds $\kb{\R}$ for $\Q$ based on $f$, \ie a \bds
$\kb{\R}$ for $\Q$ with the minimum $f(\Q, \kb{\R})$ among all \bdss
that are in the normal form for $\Q$.


\stitle{Complexity}. Its  decision problem is to decide, given $\Q$, $f$ and a
number $h$, whether there exists a \bds $\kb{\R}$ for
$\Q$ such that $f(\Q, \kb{\R})\leq h$.
We next show that the problem is intractable.
  Here an \SPC query 
  is {\em self-join free} if it has no self-join.


\begin{theorem}\label{thm-complexity}
  The \baav schema selection problem
  is \NP-complete for \warn{\SQL} %\SPC
  queries. 
It remains \NP-hard even $\Q$ consists of self-join free
\SPC queries only \warn{and $c_{3} = c_{4} = 0$ in
%the aggregate rank function
$f$.}
\end{theorem}

%\warn{Extend it to \SQL instead of \SPC}
\vspace{-0.4ex}

\begin{proofS}
To verify the upper bound, we first prove a small model
property: for any \bds $\kb{\R}$, there exists a \bds $\kb{\R}'$
that consists of no more than $\cd{\Q}$ \bss, each of size
bounded by $|\R|$, such that $f(\Q, \kb{\R}) \geq f(\Q,
\kb{\R}')$. Based on this, we give an \NP algorithm for selecting
  \bds that works as follows:
it first guesses a set $\kb{\R}$ of \bss with attributes from
$\R$ such that $\kb{\R}$ contains at most $\cd{\Q}$ \bss,
each of size at most $|\R|$;
it then checks whether $f(\Q, \kb{\R})\leq h$ and returns
$\kb{\R}$ if so.

The lower bound is verified by
reduction from the minimum set cover problem, which is
\NP-complete (cf.~\cite{GaJo79}).
The reduction uses $\Q$ with a single
self-join free \SPC query and only measures (1) and (2) in the
aggregate rank function $f$.
\end{proofS}


